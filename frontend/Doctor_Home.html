<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        display: flex;
      }

      .kiri {
        width: 75%;
        padding: 20px;
        box-sizing: border-box;
      }

      .kanan {
        width: 25%;
        padding: 20px;
        box-sizing: border-box;
      }

      .totalappointmentcontainer {
        display: flex;
        background-color: #4e9ea7;
        width: 80%;
        border-radius: 15px;
        margin: 20px;
        padding: 15px;
      }
      h3{
        margin-bottom: 3px;
        font-size: 20px;
        font-weight: bold;
      }
      .table-container {
        border: 3px solid #f5f5f5;
        border-radius: 15px;
        overflow: auto;
      }

      .table1 {
        width: 100%;
        border-collapse: collapse;
      }

      .table1 th {
        background-color: #e7e7e7;
        padding: 10px;
        text-align: left;
        color: #929091;
        font-weight: bold;
        padding:10px 20px;
      }

      .table1 td {
        padding: 10px 20px;
        border:none;
        background-color: #fff;
        border-radius:15px;
        margin: 5px;
      }

      .image-box {
        width: 30%;
      }

      .image-box img {
        max-width: 100%;
      }

      .data-box {
        width: 70%;
        color: #fff;
        font-weight: bold;
        font-size: 30px;
      }

      .bottom-row {
        margin-top: 10px;
        color: #fff;
        font-size: 15px;
        text-align: center;
      }
      #userInfo {
        font-weight: bolder;
        font-size: 30px;
        margin-bottom: 10px;
        text-align: right;
        margin-right: 5px;
      }

      #dateInfo {
        font-size: 16px;
        color: #666;
        text-align: right;
        padding-top: 0;
        margin-right: 5px;
      }
      #availabilityTable {
            width: 100%;
            border-collapse: collapse;
        }
        #availabilityTable th, #availabilityTable td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        #availabilityTable th {
            background-color: #f2f2f2;
        }
        #availabilityTable caption {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .available {
            display: none;
        }
        .unavailable {
            background-color: #8E004A;
        }
        
        tr{
            height:15px;
        }
        #appointmentdataUpperRow{
          text-align: center;
        }
    </style>
</head>
<script src="logout.js"></script>
<script>authentication();</script>
<body>
    <div id="headerContainer"></div>

    <div class="container">
      <div class="kiri">
        <h3>View Appointment (Today)</h3>
        <div class="table-container">
          <table class="table1">
            <thead>
              <tr>
                <th style="width: 5%">No</th>
                <th style="width: 20%">Name</th>
                <th style="width: 10%">Gender</th>
                <th style="width: 30%">Time</th>
              </tr>
            </thead>
            <tbody id="appointmentTable">
              <!-- Table content will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="kanan">
        <div id="userInfo">Hello Username</div>
        <div id="dateInfo"></div>
        <br>
    <div class="totalappointmentcontainer">
      <div class="image-box">
        <img src="appointment.png" alt="appointment_icon">
      </div>
      <div class="data-box">
        <div class="upper-row" id="appointmentdataUpperRow">
          <!-- Data from backend will be inserted here -->
        </div>
        <div class="bottom-row">
            Total Appointment (Today)
        </div>
      </div>
    </div>
    </div>
    </div>
    <table id="availabilityTable">
      this table need to modify again
        <caption>Doctor's Availability</caption>
        <tr>
            <th scope="col">Time</th>
            <th scope="col">Time Slot</th>
            <!-- Weekday columns will be dynamically generated -->
        </tr>
        <!-- Time slots from 8am to 11am -->
        <tr>
            <th rowspan="3" scope="rowgroup">8am</th>
            <td>8:00-8:20</td>
            <!-- Morning session availability will be dynamically generated -->
        </tr>
        <tr>
            <td>8:20-8:40</td>
            <!-- Morning session availability will be dynamically generated -->
        </tr>
        <tr>
            <td>8:40-9:00</td>
            <!-- Morning session availability will be dynamically generated -->
        </tr>
        <!-- Additional time slots for the morning session -->
        <!-- Dynamically generated time slots for the morning session -->
        <tr>
            <th rowspan="3" scope="rowgroup">9am</th>
            <td>9:00-9:20</td>
        </tr>
        <tr>
            <td>9:20-9:40</td>
        </tr>
        <tr>
            <td>9:40-10:00</td>
        </tr>
        <!-- Dynamically generated time slots for the morning session -->
        <tr>
            <th rowspan="3" scope="rowgroup">10am</th>
            <td>10:00-10:20</td>
        </tr>
        <tr>
            <td>10:20-10:40</td>
        </tr>
        <tr>
            <td>10:40-11:00</td>
        </tr>
        <!-- Dynamically generated time slots for the morning session -->
        <tr>
            <th rowspan="3" scope="rowgroup">11am</th>
            <td>11:00-11:20</td>
        </tr>
        <tr>
            <td>11:20-11:40</td>
        </tr>
        <tr>
            <td>11:40-12:00</td>
        </tr>
        <!-- Time slots from 2pm to 5pm -->
        <tr>
            <th rowspan="3" scope="rowgroup">2pm</th>
            <td>14:00-14:20</td>
            <!-- Afternoon session availability will be dynamically generated -->
        </tr>
        <tr>
            <td>14:20-14:40</td>
            <!-- Afternoon session availability will be dynamically generated -->
        </tr>
        <tr>
            <td>14:40-15:00</td>
            <!-- Afternoon session availability will be dynamically generated -->
        </tr>
        <!-- Additional time slots for the afternoon session -->
        <!-- Dynamically generated time slots for the afternoon session -->
        <tr>
            <th rowspan="3" scope="rowgroup">3pm</th>
            <td>15:00-15:20</td>
        </tr>
        <tr>
            <td>15:20-15:40</td>
        </tr>
        <tr>
            <td>15:40-16:00</td>
        </tr>
        <!-- Dynamically generated time slots for the afternoon session -->
        <tr>
            <th rowspan="3" scope="rowgroup">4pm</th>
            <td>16:00-16:20</td>
        </tr>
        <tr>
            <td>16:20-16:40</td>
        </tr>
        <tr>
            <td>16:40-17:00</td>
        </tr>
        <!-- Dynamically generated time slots for the afternoon session -->
        <tr>
            <th rowspan="3" scope="rowgroup">5pm</th>
            <td>17:00-17:20</td>
        </tr>
        <tr>
            <td>17:20-17:40</td>
        </tr>
        <tr>
            <td>17:40-18:00</td>
        </tr>
    </table>
    <br><br>
    <div id="footerContainer"></div>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script>
      let appointmentNo = 0;
      document.addEventListener("DOMContentLoaded", function() {
        fetchUserInfo();
        fetchTodaysAppointment();
        fetchAppointmentNumber()
      });

        fetch("Doctor_Header.html")
          .then((response) => response.text())
          .then((html) => {
            document.getElementById("headerContainer").innerHTML = html;
          });
        
          fetch("Footer.html")
        .then((response) => response.text())
        .then((html) => {
          document.getElementById("footerContainer").innerHTML = html;
          document.getElementById("year").textContent = new Date().getFullYear();
        });

        function fetchUserInfo() { //hello username
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("doctorId");
         const userInfoElement = document.getElementById('userInfo');
         userInfoElement.textContent = `Hello ${username}`;
       }

       function fetchTodaysAppointment() {
        fetch('/retrieveAllAppointments')
        .then(response => response.json())
        .then(data => {
            const appointmentTable = document.getElementById('appointmentTable');
            const today = moment().format('YYYY-MM-DD');
            data.forEach(entry => {
                if (entry.appointmentDate === today) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${entry.name}</td><td>${entry.gender}</td><td>${entry.time}</td>`;
                    appointmentTable.appendChild(row);
                    appointmentNo++;
                }
            });
            fetchAppointmentNumber();
        })
        .catch(error => console.error('Error fetching todays appointment:', error));
}


function fetchAppointmentNumber() {
      const upperRow = document.getElementById('appointmentdataUpperRow');
      upperRow.textContent = appointmentNo;
}

  // Display today's date
  const dateInfoElement = document.getElementById('dateInfo');
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  dateInfoElement.textContent = today;

  // Function to generate dates for this week and next week (excluding weekends)
  function generateDates() {
            const today = new Date();
            const dates = [];
            let dayIncrement = 0;

            while (dates.length < 10) {
                const date = new Date(today.getTime() + dayIncrement * 24 * 60 * 60 * 1000);
                const dayOfWeek = date.getDay();

                // Skip Saturday (6) and Sunday (0)
                if (dayOfWeek !== 6 && dayOfWeek !== 0) {
                    const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const day = date.getDate();
                    const month = date.toLocaleDateString('en-US', { month: 'short' });
                    dates.push(`${weekday}, ${day} ${month}`);
                }

                dayIncrement++;
            }

            return dates;
        }

        // Function to dynamically generate table headers
        function generateTableHeaders() {
            const table = document.getElementById('availabilityTable');
            const dates = generateDates();

            for (let i = 0; i < dates.length; i++) {
                const th = document.createElement('th');
                th.textContent = dates[i];
                table.querySelector('tr').appendChild(th);
            }
        }

        // Call the function to generate table headers
        generateTableHeaders();
        // Function to fetch doctor availability data from the backend (all appointment)
        function fetchDoctorAvailability() {
            fetch('/retrieveAllAppointment')
                .then(response => response.json())
                .then(data => {
                    // Process the availability data and update table cells
                    updateTable(data);
                })
                .catch(error => {
                    console.error('Error fetching doctor availability:', error);
                });
        }

        // Function to update table cells based on availability data
        function updateTable(availabilityData) {
            const table = document.getElementById('availabilityTable');
            const rows = table.getElementsByTagName('tr');
            const timeCells = Array.from(rows).slice(1); // Exclude header row

            timeCells.forEach(row => {
                const timeSlot = row.cells[1].textContent.trim(); // Get the time slot
                const availability = availabilityData[timeSlot];
                if (availability === 'available') {
                    row.cells[2].classList.add('available'); // Green background
                } else if (availability === 'unavailable') {
                    row.cells[2].classList.add('unavailable'); // Red background
                }
                }
            );
        }

        // Call the function to fetch doctor availability when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchDoctorAvailability();
        });
    </script>
</body>
</html>
